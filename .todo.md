# Braintrust Go Dev Server - TODO

## Phase 1: Core Fixes (Currently Broken)

### Scorer Data Not Returning
- [ ] Extract score statistics from eval.Result
- [ ] Populate response.Scores map with actual score data (name, score, improvements, regressions)
- [ ] Test that scores are properly returned in /eval response

### /list Endpoint Improvements
- [ ] Store scorer names in registeredEval struct (currently using generic "scorer_0", "scorer_1")
- [ ] Return actual scorer names in /list response
- [ ] Add parameter definitions support in RemoteEval type
- [ ] Expose parameters in /list endpoint

---

## Phase 2: Authentication & Security

### Authentication Middleware
- [ ] Implement token extraction middleware (x-bt-auth-token, Bearer, direct)
- [ ] Create RequestContext type (appOrigin, token, state)
- [ ] Add context to request via middleware

### Authorization & Caching
- [ ] Implement AuthCache with LRU cache (32 entries max)
- [ ] Add CheckAuthorizedMiddleware for /list and /eval
- [ ] Integrate with braintrust.Login() for token validation
- [ ] Cache login state by token+orgName key

### Organization Restriction
- [ ] Add org name validation when Config.OrgName is set
- [ ] Return 401 if user doesn't belong to configured org
- [ ] Add tests for org restriction

---

## Phase 3: Advanced Features

### Parameter Validation
- [ ] Define Parameter and ParameterDef types
- [ ] Support "prompt" parameter type validation
- [ ] Support "data" parameter type with JSON Schema validation
- [ ] Integrate github.com/xeipuuv/gojsonschema for schema validation
- [ ] Return 400 Bad Request with detailed error messages
- [ ] Add tests for parameter validation

### SSE Streaming
- [ ] Add SSE writer utility
- [ ] Implement streaming handler (handleEvalStream)
- [ ] Send "start" event at beginning
- [ ] Send "progress" events during execution
- [ ] Send "summary" event at end
- [ ] Send "done" event to close stream
- [ ] Handle "error" events
- [ ] Wire up ReportProgress callback from eval framework
- [ ] Add tests for SSE streaming

### Remote Scorer Integration
- [ ] Parse scores[] array from request
- [ ] Support all FunctionID formats (function_id, name, prompt_session_id, inline_code, global_function)
- [ ] Create proxy scorers that call Function Invoke API
- [ ] Pass remote scorers to eval.Run()
- [ ] Merge remote scorer results with local scorer results
- [ ] Add tests for remote scorers

### Dataset Loading by Name
- [ ] Parse project_name + dataset_name from request
- [ ] Call eval.QueryDataset with project/dataset names
- [ ] Handle errors when dataset not found
- [ ] Add tests for dataset loading by name

### Dataset Loading by ID
- [ ] Parse dataset_id from request
- [ ] Call Braintrust API to get dataset metadata
- [ ] Extract projectId and dataset name from metadata
- [ ] Call eval.QueryDataset with extracted info
- [ ] Add tests for dataset loading by ID

### BTQL Filter Support
- [ ] Parse _internal_btql from request
- [ ] Pass BTQL filter to QueryDataset
- [ ] Add tests for BTQL filtering

---

## Phase 4: Polish & Testing

### Error Handling
- [ ] Improve error messages for common failures
- [ ] Add proper HTTP status codes for all error cases
- [ ] Add structured error responses (JSON format)
- [ ] Log errors with context

### Request Timeout
- [ ] Add configurable request timeout
- [ ] Ensure eval.Run respects context cancellation
- [ ] Return 408 Request Timeout on timeout

### Testing
- [ ] Add unit tests for middleware
- [ ] Add unit tests for handlers
- [ ] Add integration tests for /list endpoint
- [ ] Add integration tests for /eval endpoint
- [ ] Add integration tests for SSE streaming
- [ ] Add tests for CORS
- [ ] Add tests for authentication
- [ ] Add tests for parameter validation
- [ ] Add tests for dataset loading
- [ ] Add tests for remote scorers

### Documentation
- [ ] Add GoDoc comments to all public types and functions
- [ ] Create examples/ directory with real-world examples
- [ ] Add README.md for devserver package
- [ ] Document configuration options
- [ ] Document error responses

### Performance
- [ ] Add request logging with duration
- [ ] Add metrics/instrumentation hooks
- [ ] Profile eval execution
- [ ] Optimize JSON marshaling/unmarshaling

---

## Future Enhancements

### EvalHooks Support
- [ ] Define EvalHooks interface in braintrust package
- [ ] Support Expected, Parameters, TrialIndex fields
- [ ] Support Metadata and Tags (mutable)
- [ ] Support Span field for tracing
- [ ] Auto-detect task signature (1 arg vs 2 args)
- [ ] Pass hooks to tasks that accept them

### Environment Variable Origins
- [ ] Read WHITELISTED_ORIGIN env var
- [ ] Read BRAINTRUST_APP_URL env var
- [ ] Add to allowed origins list

### Graceful Shutdown
- [ ] Implement graceful shutdown in Start()
- [ ] Wait for in-flight requests to complete
- [ ] Close connections cleanly

### Rate Limiting
- [ ] Add rate limiting per origin
- [ ] Add rate limiting per auth token
- [ ] Return 429 Too Many Requests

---

## Known Issues

- [ ] Scorer data not populated in response (handlers.go:136)
- [ ] Scorer names hardcoded as "scorer_0", "scorer_1" (handlers.go:46)
- [ ] No authentication middleware implemented yet
- [ ] No parameter validation
- [ ] No SSE streaming support
- [ ] No remote scorer support
